plugins {
    id 'maven-publish'
}

repositories {
    mavenLocal()
    mavenCentral()
    maven {
        credentials {
            username mavenUser
            password mavenPassword
        }
        url mavenRepo
    }
}

configurations {
    docker
}

ext {
    jarVersion = "0.1.0"
    jarArtifactId = "mars-rover-photo-collector-app"
    jarGroupId = "com.leonardo.rocha"
}

dependencies {
    docker "${jarGroupId}:${jarArtifactId}:${jarVersion}"
}
task clean(){
    delete "${buildDir}"
}

task copySpringBootJar(type: Copy){
    from project.configurations.docker.resolvedConfiguration.resolvedArtifacts[0].file
    into "${buildDir}/dockerStage"
}

task copyDockerFile(type:Copy){
    dependsOn project.tasks.copySpringBootJar
    from "${projectDir}/Dockerfile"
    into "${buildDir}/dockerStage"
}

task docker(){
    dependsOn project.tasks.copyDockerFile

    def jarFileName
    def dockerRepoName
    def commandLineString

    doLast{
        exec {
            workingDir("${buildDir}/dockerStage/")
            jarFileName = "${jarArtifactId}-${jarVersion}.jar"
            dockerRepoName = "leonardorocha1990/${jarArtifactId}:${jarVersion}"
            commandLineString = "docker build --build-arg JAR_FILE=${jarFileName} -t ${dockerRepoName} ."
            commandLine commandLineString.split(" ")
        }
    }
}

task dockerLogout(){
    def commandLineString 
    doLast {
        exec {
            commandLineString = "docker logout"
            commandLine commandLineString.split(" ")
        }
    }
}

task dockerLogin(){
    dependsOn project.tasks.dockerLogout
    def commandLineString 
    exec {
        commandLineString = "docker login --username ${dockerUser} --password ${dockerPassword}"
        commandLine commandLineString.split(" ")
    }
}

task dockerPush(){
    def dockerRepoName
    def commandLineString 
    doLast{
        exec {
            dockerRepoName = "leonardorocha1990/${jarArtifactId}:${jarVersion}"
            commandLineString = "docker push ${dockerRepoName}"
            commandLine commandLineString.split(" ")
        }
    }
} 
